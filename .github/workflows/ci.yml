name: CI

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main

env:
  DEV_IMAGE_TAG: tsi-dev:ci
  DEV_CACHE_SCOPE: tsi-dev-ci

jobs:
  python-quality:
    name: Python quality gates (Docker)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true
          submodules: recursive

      - name: Free disk space
        run: ./scripts/ci-free-disk.sh
        shell: bash

      - name: Setup Docker environment
        uses: ./.github/actions/setup-docker
        with:
          dev-image-tag: ${{ env.DEV_IMAGE_TAG }}
          dev-cache-scope: ${{ env.DEV_CACHE_SCOPE }}

      - name: Run linters and type checks inside container
        run: |
          docker run --rm \
            --env CI=1 \
            "${DEV_IMAGE_TAG}" \
            bash -lc '
              set -euo pipefail
              ruff check src/ tests/
              black --check src/ tests/
              mypy src/
            '

  python-tests:
    name: Python tests (${{ matrix.subset }}) (Docker)
    runs-on: ubuntu-latest
    needs:
      - python-quality
    strategy:
      fail-fast: false
      matrix:
        subset:
          - unit
          - integration
          - e2e
          - unmarked
          - bindings

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true
          submodules: recursive

      - name: Free disk space
        run: ./scripts/ci-free-disk.sh
        shell: bash

      - name: Setup Docker environment
        uses: ./.github/actions/setup-docker
        with:
          dev-image-tag: ${{ env.DEV_IMAGE_TAG }}
          dev-cache-scope: ${{ env.DEV_CACHE_SCOPE }}

      - name: Run pytest subset inside container
        env:
          SUBSET: ${{ matrix.subset }}
        run: |
          CONTAINER="${SUBSET}-tests"
          docker run \
            --name "${CONTAINER}" \
            --env CI=1 \
            --env TEST_SUBSET="${SUBSET}" \
            "${DEV_IMAGE_TAG}" \
            bash -lc '
              set -euo pipefail
              case "${TEST_SUBSET}" in
                unit)
                  pytest -m unit --cov=src --cov-report=xml --cov-report=html --cov-report=term-missing:skip-covered
                  ;;
                integration)
                  pytest -m integration --no-cov
                  ;;
                e2e)
                  pytest -m e2e --no-cov
                  ;;
                unmarked)
                  pytest -m "not unit and not integration and not e2e" --no-cov
                  ;;
                bindings)
                  pytest backend/tests --no-cov
                  ;;
                *)
                  echo "error: unknown subset ${TEST_SUBSET}" >&2
                  exit 1
                  ;;
              esac
            '
          echo "${CONTAINER}" > container_name.txt

      - name: Copy coverage artifacts
        if: matrix.subset == 'unit'
        run: |
          CONTAINER="$(cat container_name.txt)"
          docker cp "${CONTAINER}":/workspace/coverage.xml coverage.xml 2>/dev/null || true
          docker cp "${CONTAINER}":/workspace/htmlcov htmlcov 2>/dev/null || true

      - name: Remove test container
        if: always()
        run: |
          if [[ -f container_name.txt ]]; then
            CONTAINER="$(cat container_name.txt)"
            docker rm "${CONTAINER}" || true
          fi

      - name: Upload unit coverage
        if: matrix.subset == 'unit' && hashFiles('coverage.xml') != ''
        uses: actions/upload-artifact@v4
        with:
          name: unit-coverage
          path: |
            coverage.xml
            htmlcov/

  rust:
    name: Rust checks (Docker)
    runs-on: ubuntu-latest
    needs:
      - python-quality

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true
          submodules: recursive

      - name: Free disk space
        run: ./scripts/ci-free-disk.sh
        shell: bash

      - name: Setup Docker environment
        uses: ./.github/actions/setup-docker
        with:
          dev-image-tag: ${{ env.DEV_IMAGE_TAG }}
          dev-cache-scope: ${{ env.DEV_CACHE_SCOPE }}

      - name: Run cargo fmt/clippy/test inside container
        run: |
          docker run --rm \
            --env CI=1 \
            "${DEV_IMAGE_TAG}" \
            bash -lc '
              set -euo pipefail
              cargo fmt --all --check
              cargo clippy --all-targets --all-features -- -D warnings
              cargo test --all-features
            '
